<?xml version="1.0"?>
<ruleset name="Advanced Image Optimizer">
    <description>Coding standards for Advanced Image Optimizer plugin</description>

    <!-- What to scan -->
    <file>.</file>
    
    <!-- Exclude patterns -->
    <exclude-pattern>*/vendor/*</exclude-pattern>
    <exclude-pattern>*/node_modules/*</exclude-pattern>
    <exclude-pattern>*/bin/*</exclude-pattern>
    <exclude-pattern>*/languages/*</exclude-pattern>
    <exclude-pattern>*/tests/coverage/*</exclude-pattern>
    <exclude-pattern>*/.git/*</exclude-pattern>
    <exclude-pattern>*/assets/js/*.min.js</exclude-pattern>
    <exclude-pattern>*/assets/css/*.min.css</exclude-pattern>

    <!-- How to scan -->
    <arg value="sp"/> <!-- Show sniff and progress -->
    <arg name="basepath" value="."/> <!-- Strip the file paths down to the relevant bit -->
    <arg name="colors"/>
    <arg name="extensions" value="php"/>
    <arg name="parallel" value="8"/> <!-- Enables parallel processing when available for faster results -->

    <!-- Rules: Check PHP version compatibility -->
    <config name="minimum_supported_wp_version" value="5.8"/>
    <config name="testVersion" value="7.4-"/>

    <!-- Rules: WordPress Coding Standards -->
    <rule ref="WordPress">
        <!-- Exclude some rules that might be too strict for plugin development -->
        <exclude name="WordPress.Files.FileName.InvalidClassFileName"/>
        <exclude name="WordPress.Files.FileName.NotHyphenatedLowercase"/>
        <exclude name="Squiz.Commenting.FileComment.Missing"/>
        <exclude name="Squiz.Commenting.ClassComment.Missing"/>
        <exclude name="Squiz.Commenting.FunctionComment.Missing"/>
        <exclude name="Generic.Commenting.DocComment.MissingShort"/>
    </rule>

    <!-- Rules: WordPress Extra -->
    <rule ref="WordPress-Extra">
        <!-- Allow short array syntax -->
        <exclude name="Generic.Arrays.DisallowShortArraySyntax"/>
    </rule>

    <!-- Rules: WordPress Docs -->
    <rule ref="WordPress-Docs"/>

    <!-- Rules: WordPress VIP -->
    <rule ref="WordPress-VIP-Go">
        <!-- Allow direct database queries for optimization purposes -->
        <exclude name="WordPress.DB.DirectDatabaseQuery.DirectQuery"/>
        <exclude name="WordPress.DB.DirectDatabaseQuery.NoCaching"/>
        <!-- Allow file operations for image processing -->
        <exclude name="WordPress.WP.AlternativeFunctions.file_system_read_fopen"/>
        <exclude name="WordPress.WP.AlternativeFunctions.file_system_read_fclose"/>
        <exclude name="WordPress.WP.AlternativeFunctions.file_system_read_fwrite"/>
    </rule>

    <!-- Custom rules for this project -->
    <rule ref="WordPress.Security.EscapeOutput">
        <properties>
            <property name="customAutoEscapedFunctions" type="array">
                <element value="esc_html_e"/>
                <element value="esc_attr_e"/>
            </property>
        </properties>
    </rule>

    <!-- Allow exec() function for binary execution -->
    <rule ref="WordPress.PHP.DiscouragedPHPFunctions">
        <properties>
            <property name="exclude" type="array">
                <element value="exec"/>
                <element value="shell_exec"/>
            </property>
        </properties>
    </rule>

    <!-- Set minimum WordPress version -->
    <config name="minimum_supported_wp_version" value="5.8"/>
</ruleset>